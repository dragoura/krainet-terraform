image: 
  name: hashicorp/terraform:1.7.5
  entrypoint: [""]

stages:
  - fmt
  - validate
  - plan
  - apply
  - ansible
  - destroy

variables:
  TF_DIR: "terraform"
  TF_PLAN_FILE: "plan.tfplan"

cache:
  key: "$CI_COMMIT_REF_SLUG-terraform"
  paths:
    - .terraform/
    - ${TF_DIR}/.terraform/

.before_tf: &before_tf
  before_script:
    - cd "$TF_DIR"
    - terraform --version
    - terraform init -input=false

fmt:
  stage: fmt
  <<: *before_tf
  script:
    - terraform fmt -check -recursive

validate:
  stage: validate
  <<: *before_tf
  needs: ["fmt"]
  script:
    - terraform validate

plan:
  stage: plan
  <<: *before_tf
  needs: ["validate"]
  script:
  - |
      terraform plan -input=false -out="$TF_PLAN_FILE" \
        -var "do_token=$DIGITALOCEAN_TOKEN" \
        -var "ssh_key_fingerprint=$DO_SSH_KEY_FINGERPRINT" \
        -var "domain=$DNS_DOMAIN" 
  artifacts:
    paths:
      - "$TF_DIR/$TF_PLAN_FILE"
    expire_in: 1 week

apply:
  stage: apply
  <<: *before_tf
  needs: ["plan"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  script:
    - terraform apply -input=false -auto-approve "$TF_PLAN_FILE"
    - terraform output -raw droplet_ip > droplet_ip.txt
  artifacts:
    when: always
    paths:
      - "$TF_DIR/terraform.tfstate"
      - "$TF_DIR/terraform.tfstate.backup"
      - "$TF_DIR/droplet_ip.txt"
    expire_in: 1 week
  environment:
    name: infra-prod

ansible:
  stage: ansible
  needs: ["apply"]
  image:
    name: python:3.12-slim
    entrypoint: [""]
  before_script:
    - python --version
    - pip install --no-input --upgrade pip
    - pip install --no-input ansible==9.5.1 paramiko==3.4.0
    - apt-get update && apt-get install -y --no-install-recommends openssh-client && rm -rf /var/lib/apt/lists/*
    - eval $(ssh-agent -s)
    - |
      set -e
      printf "%s" "$ANSIBLE_SSH_PRIVATE_KEY" | tr -d '\r' | base64 -d | ssh-add -
  script:
    - |
      set -euo pipefail
      export ANSIBLE_HOST_KEY_CHECKING=False
      HOST_IP=$(cat "$TF_DIR/droplet_ip.txt")
      cd ansible
      printf "[workers]\nkrainet ansible_host=%s\n" "$HOST_IP" > ci_inventory.ini
      ansible-playbook -i ci_inventory.ini -u root main.yaml
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

destroy:
  stage: destroy
  <<: *before_tf
  needs:
    - job: apply
      artifacts: true
  dependencies:
    - apply
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  allow_failure: true
  script:
  - |
      terraform destroy -input=false -auto-approve \
        -var "do_token=$DIGITALOCEAN_TOKEN" \
        -var "ssh_key_fingerprint=$DO_SSH_KEY_FINGERPRINT" \
        -var "domain=$DNS_DOMAIN" 